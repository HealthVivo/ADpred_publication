
ALL_SCORES1 = [[('C', 0.02247014831444764),
              ('T', 0.057903843733384308),
              ('A', 0.10370837683591219),
              ('G', 2.24803586793255664)],
             [('T', 0.046608227674354567),
              ('G', 0.048827667087419063),
              ('A', 0.084338697696451109),
              ('C', 0.92994511407402669)],
             [('G', 0.0),
              ('T', 0.011098351287382456),
              ('A', 0.022196702574764911),
              ('C', 1.8164301607015951)],
             [('C', 0.020803153636453006),
              ('T', 0.078011826136698756),
              ('G', 0.11268374886412044),
              ('A', 0.65529933954826969)],
             [('T', 0.017393530660176126),
              ('A', 0.030438678655308221),
              ('G', 0.22611589858228964),
              ('C', 0.45078233627623127)],
             [('G', 0.022364103549245576),
              ('A', 0.043412671595594352),
              ('T', 0.097349627214363091),
              ('C', 0.1657574733649966)],
             [('C', 0.03264675899941203),
              ('T', 0.045203204768416654),
              ('G', 0.082872542075430544),
              ('A', 1.0949220710572034)],
             [('C', 0.0),
              ('T', 0.0076232429756614498),
              ('A', 0.011434864463492175),
              ('G', 1.8867526364762088)],
             [('C', 0.0018955903000026028),
              ('T', 0.0094779515000130137),
              ('A', 0.35637097640048931),
              ('G', 0.58005063180079641)],
             [('A', 0.01594690817903021),
              ('C', 0.017541598996933229),
              ('T', 0.2774762023151256),
              ('G', 0.48638069946042134)],
             [('A', 0.003770051401807444),
              ('C', 0.0075401028036148881),
              ('T', 0.011310154205422331),
              ('G', 1.8624053924928772)],
             [('C', 0.036479877757360731),
              ('A', 0.041691288865555121),
              ('T', 0.072959755514721461),
              ('G', 1.1517218549109602)],
             [('G', 0.011831087684038642),
              ('T', 0.068620308567424126),
              ('A', 0.10174735408273231),
              ('C', 1.0009100180696691)],
             [('C', 0.015871770937774379),
              ('T', 0.018757547471915176),
              ('A', 0.32176408355669878),
              ('G', 0.36505073156881074)],
             [('A', 0.022798100897300954),
              ('T', 0.024064662058262118),
              ('G', 0.24571286522646588),
              ('C', 0.34070495229855319)]]

ALL_SCORES2 = [[('A', 12.01653482213365913),
              ('G', 2.026710097292833978),
              ('I', 3.035613463057111966),
              ('T', 5.057235922770358522)],
             [('I', 0.020055669245080433),
              ('G', 0.023816107228533015),
              ('A', 0.031336983195438178),
              ('T', 0.058913528407423782)],
             [('T', 0.018666958185377256),
              ('G', 0.084001311834197651),
              ('A', 0.093334790926886277),
              ('I', 0.30333807051238043)],
             [('I', 0.0),
              ('G', 0.0),
              ('A', 0.12027512306044359),
              ('T', 0.82203948252180525)],
             [('I', 0.012698627658037786),
              ('A', 0.053334236163758708),
              ('T', 0.096509570201087178),
              ('G', 0.10920819785912497)],
             [('T', 0.0),
              ('G', 0.089472611853783468),
              ('A', 0.1930724782107959),
              ('T', 0.22132698721725386)],
             [('I', 0.020962390607965918),
              ('A', 0.026202988259957396),
              ('G', 0.066380903591892068),
              ('T', 0.07336836712788071)],
             [('G', 0.0),
              ('A', 0.10236420974570831),
              ('I', 0.15354631461856247),
              ('T', 0.29173799777526871)],
             [('G', 0.027681850851852024),
              ('I', 0.089966015268519078),
              ('A', 0.089966015268519078),
              ('T', 0.53287562889815143)],
             [('A', 0.034165612000664765),
              ('I', 0.06833122400132953),
              ('G', 0.072601925501412631),
              ('T', 0.28186629900548432)],
             [('G', 0.0),
              ('A', 0.037325935579058833),
              ('I', 0.23328709736911771),
              ('T', 0.72785574379164719)],
             [('A', 0.017470244196759552),
              ('I', 0.062892879108334396),
              ('G', 0.094339318662501587),
              ('T', 0.19916078384305891)],
             [('G', 0.0),
              ('A', 0.096447131567581681),
              ('I', 0.15844885900388422),
              ('T', 0.48223565783790845)],
             [('G', 0.0),
              ('A', 0.069291952024925829),
              ('I', 0.20787585607477749),
              ('T', 0.46425607856700307)],
             [('G', 0.0),
              ('A', 0.0),
              ('I', 0.21713201856318373),
              ('T', 3.1495224512168551)],
             [('G', 0.0),
              ('A', 0.048934292002649343),
              ('T', 0.27263391258618919),
              ('I', 0.42642740173737281)],
             [('A', 0.0),
              ('G', 0.053607190685875404),
              ('I', 0.2054942309625224),
              ('T', 0.69689347891638032)],
             [('G', 0.0),
              ('A', 0.0),
              ('I', 0.31312908494534769),
              ('T', 0.84220926295645249)],
             [('G', 0.0),
              ('I', 0.068079835765814778),
              ('A', 0.068079835765814778),
              ('D', 1.3207488138568066)],
             [('G', 0.020257705570431345),
              ('A', 0.020257705570431345),
              ('I', 0.048618493369035232),
              ('T', 0.055371061892512348)],
             [('G', 0.0),
              ('A', 0.076286510680262556),
              ('I', 0.20538675952378382),
              ('D', 0.34622339462580698)]]



import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
from matplotlib.text import TextPath
from matplotlib.patches import PathPatch
from matplotlib.font_manager import FontProperties

aa_letters = ['A', 'C', 'D', 'E', 'F', 
              'G', 'H', 'I', 'K', 'L', 
              'M', 'N', 'P', 'Q', 'R', 
              'S', 'T', 'V', 'W', 'Y', 'X']

aa_textpaths = {'A':(-0.301,0),
                'C':(-0.301,0),
                'D':(-0.301,0),
                'E':(-0.301,0),
                'F':(-0.301,0),
                'G':(-0.301,0),
                'H':(-0.301,0),
                'I':(-0.301,0), 
                'K':(-0.301,0), 
                'L':(-0.301,0),
                'M':(-0.301,0), 
                'N':(-0.301,0), 
                'P':(-0.301,0), 
                'Q':(-0.301,0), 
                'R':(-0.301,0), 
                'S':(-0.301,0), 
                'T':(-0.301,0), 
                'V':(-0.301,0), 
                'W':(-0.301,0), 
                'Y':(-0.301,0), 
                'X':(-0.301,0)
                }

fp = FontProperties(family="Ubuntu", weight="bold") 

LETTERS = {i: TextPath((aa_textpaths[i]), i, size=1, prop=fp) for i in aa_letters}

globscale = 1.35


# define color schemes
aa_1 = {i:'blue' for i in ['R','H','K']}
aa_2 = {i:'red' for i in ['D','E']}
aa_3 = {i:'cyan' for i in ['S','T','N','Q']}
aa_4 = {i:'green' for i in ['A','I','L','M','F','W','Y','V']}
aa_5 = {i:'yellow' for i in ['C','G','P']}

COLOR_SCHEME = {**aa_1,**aa_2,**aa_3,**aa_4,**aa_5}

def letterAt(letter, x, y, yscale=1, ax=None):
    text = LETTERS[letter]

    t = mpl.transforms.Affine2D().scale(1*globscale, yscale*globscale) + \
        mpl.transforms.Affine2D().translate(x,y) + ax.transData
    p = PathPatch(text, lw=0, fc=COLOR_SCHEME[letter],  transform=t)
    if ax != None:
        ax.add_artist(p)
    return p

def LOGO(ALL_SCORES2):

    fig, ax = plt.subplots(figsize=(10,3))

    all_scores = ALL_SCORES2
    print(len(ALL_SCORES2))

    bottom = 0
    upper = 30
    x = 1+bottom

    maxi = 0
    for scores in all_scores[bottom:upper]:
        y = 0
        for base, score in scores:
            letterAt(base, x,y, score, ax)
            y += score
        x += 1
        maxi = max(maxi, y)

    plt.xticks(range(bottom,x))
    plt.xlim((bottom, x)) 
    plt.ylim((0, maxi)) 
    plt.tight_layout()      
    #plt.show()
    FILE_OUT = 'test_logo3.png'
    print('Saving png to: '+FILE_OUT)         
    plt.savefig(FILE_OUT)
    
    return fig


def ohe_2_aa_analog(ohe_data):
    global ss
    seq = ohe_data[:,:20].reshape(30,20)
    SS =  ohe_data[:,20:].reshape(30,3)

    seq_list = []
    for i in seq:
        seq_list.append([(i,j) for i,j in zip(aa,i)])
        
    ss_list = []
    for i in SS:
        ss_list.append([(i,j) for i,j in zip(ss,i)])
        
    return seq_list, ss_list


'''
df = get_enrichment_scores_table()
df['score'] = np.sum(df.iloc[:,1:]*ARG3_FACS_RFU, axis=1) / (df.iloc[:,0] + 1)

best_20_enrichment = list(df.sort_values('score')[::-1][:20].index)
best_20_ADscore = positives[np.argsort([ADPred.predict(prepare_ohe(sample).reshape(1,30,23,1))[0][0] for sample in positives])[-20:],0]

ids_enrichment = [np.where(positives[:,0]==sample)[0][0] for sample in best_20_enrichment]
ids_adpred = [np.where(positives[:,0]==sample)[0][0] for sample in best_20_ADscore]

ohes1 = np.array([prepare_ohe(i) for i in positives[ids_enrichment]])
ohes2 = np.array([prepare_ohe(i) for i in positives[ids_adpred]])

preds1 = np.hstack([ADPred.predict(i.reshape(1,30,23,1))[0][0] for i in ohes1])
preds2 = np.hstack([ADPred.predict(i.reshape(1,30,23,1))[0][0] for i in ohes2])
'''

with DeepExplain(session=K.get_session()) as de:
    input_tensor = ADPred.layers[0].input
    fModel = Model(inputs=input_tensor, outputs = ADPred.layers[-2].output)
    target_tensor = fModel(input_tensor)
    
    s0 = ohes2.shape[0]
    xs = ohes2.reshape(s0,30,23,1)
    ys = preds2.reshape(s0,1)
    
    attributions_gradin = de.explain('grad*input', target_tensor, input_tensor, xs, ys=ys)
 
#print(ohe_2_aa_analog(attributions_gradin[0])[0])
LOGO(ohe_2_aa_analog(attributions_gradin[0])[0])
#for i in range(len(attributions_gradin)):
#    ALL_SCORES1, aSS1 = ohe_2_aa_analog(attributions_gradin[i])
#    LOGO(ALL_SCORES1)